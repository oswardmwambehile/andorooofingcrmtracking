{% extends "manager/base.html" %}
{% load static %}

{% block content %}
  {% include "manager/sidebar.html" %}
  
  <div class="main-panel">
    <div class="main-header">
      {% include "manager/nav.html" %}
    </div>
    <div class="container">
      <div class="page-inner">
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
          <div></div>
          <div class="ms-md-auto py-2 py-md-0">
            <a href="#" class="btn btn-primary btn-round">Export Route Clients</a>
          </div>
        </div>

        <!-- Search Input -->
        <div class="row mb-4">
          <div class="col-md-12">
            <input type="text" id="search-input" class="form-control" placeholder="Search route clients..." value="{{ search_query }}" />
          </div>
        </div>

        <!-- Table -->
        <div class="col-md-12">
          <div class="card">
            <div class="card-header"><h4 class="card-title">Route Clients</h4></div>
            <div class="card-body">
              <div class="table-responsive" style="overflow-x: auto;">
                <table class="table table-striped table-hover" style="min-width: 1200px;">
                  <thead class="table-dark">
                    <tr>
                      <th style="white-space: nowrap;">Production Line</th>
                      <th style="white-space: nowrap;">Client / Company</th>
                      <th style="white-space: nowrap;">Contact</th>
                      <th style="white-space: nowrap;">Purpose</th>
                      <th style="white-space: nowrap;">Priority</th>
                      <th style="white-space: nowrap;">Next Step</th>
                      <th style="white-space: nowrap;">Added By</th>
                      <th style="white-space: nowrap;">Created At</th>
                      <th style="white-space: nowrap;">Updated At</th>
                      <th style="white-space: nowrap;">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for route in routes %}
                      <tr>
                        <td style="white-space: nowrap;">{{ route.production_line.name }}</td>
                        <td style="white-space: nowrap;">{{ route.client_name }}</td>
                        <td style="white-space: nowrap;">{{ route.contact }}</td>
                        <td style="white-space: nowrap;">{{ route.get_purpose_display }}</td>
                        <td style="white-space: nowrap;">{{ route.get_priority_display }}</td>
                        <td style="white-space: nowrap;">{{ route.next_step|truncatechars:30 }}</td>
                        <td style="white-space: nowrap;">{{ route.added_by.get_full_name|default:route.added_by.username }}</td>
                        <td style="white-space: nowrap;">{{ route.created_at|date:"Y‑m‑d H:i" }}</td>
                        <td style="white-space: nowrap;">{{ route.updated_at|date:"Y‑m‑d H:i" }}</td>
                        <td style="white-space: nowrap;">
                          <a href="{% url 'manager_view_route_client_detail' route.id %}" class="btn btn-primary btn-sm">View</a>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="10" class="text-center">No route clients found.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div id="no-results" style="display: none;" class="alert alert-warning text-center">
                No results found for the search term.
              </div>

              {% if is_paginated %}
              <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mt-3">
                  {% if routes.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1&q={{ request.GET.q }}">&laquo;</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ routes.previous_page_number }}&q={{ request.GET.q }}">&lsaquo;</a></li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    <li class="page-item disabled"><span class="page-link">&lsaquo;</span></li>
                  {% endif %}
                  {% for i in routes.paginator.page_range %}
                    {% if i == routes.number %}
                      <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                    {% elif i > routes.number|add:'-3' and i < routes.number|add:'3' %}
                      <li class="page-item"><a class="page-link" href="?page={{ i }}&q={{ request.GET.q }}">{{ i }}</a></li>
                    {% endif %}
                  {% endfor %}
                  {% if routes.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ routes.next_page_number }}&q={{ request.GET.q }}">&rsaquo;</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ routes.paginator.num_pages }}&q={{ request.GET.q }}">&raquo;</a></li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">&rsaquo;</span></li>
                    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                  {% endif %}
                </ul>
              </nav>
              {% endif %}
            </div>
          </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const table = document.querySelector('table');
            const rows = table.querySelectorAll('tbody tr');
            const noResults = document.getElementById('no-results');

            searchInput.addEventListener('input', () => {
              const val = searchInput.value.toLowerCase();
              let visible = false;
              rows.forEach(r => {
                const txt = r.textContent.toLowerCase();
                const match = txt.includes(val);
                r.style.display = match ? '' : 'none';
                if (match) visible = true;
              });
              noResults.style.display = visible ? 'none' : 'block';
            });
          });
        </script>

      </div>
    </div>
  </div>
{% endblock %}
